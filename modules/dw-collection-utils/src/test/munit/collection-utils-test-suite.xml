<?xml version="1.0" encoding="UTF-8"?>
<mule xmlns:munit="http://www.mulesoft.org/schema/mule/munit"
      xmlns:munit-tools="http://www.mulesoft.org/schema/mule/munit-tools"
      xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
      xmlns="http://www.mulesoft.org/schema/mule/core"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="
        http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
        http://www.mulesoft.org/schema/mule/munit http://www.mulesoft.org/schema/mule/munit/current/mule-munit.xsd
        http://www.mulesoft.org/schema/mule/munit-tools http://www.mulesoft.org/schema/mule/munit-tools/current/mule-munit-tools.xsd
        http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">

    <munit:config name="collection-utils-test-suite"/>

    <!-- ==================== chunk ==================== -->

    <munit:test name="test-chunk-even-split"
                description="chunk splits array into equal-sized chunks">
        <munit:execution>
            <ee:transform>
                <ee:message>
                    <ee:set-payload><![CDATA[
                        %dw 2.0
                        import modules::CollectionUtils
                        output application/json
                        ---
                        CollectionUtils::chunk([1,2,3,4], 2)
                    ]]></ee:set-payload>
                </ee:message>
            </ee:transform>
        </munit:execution>
        <munit:validation>
            <munit-tools:assert-that
                expression="#[payload]"
                is="#[MunitTools::equalTo([[1,2],[3,4]])]"/>
        </munit:validation>
    </munit:test>

    <munit:test name="test-chunk-remainder"
                description="chunk handles remainder elements">
        <munit:execution>
            <ee:transform>
                <ee:message>
                    <ee:set-payload><![CDATA[
                        %dw 2.0
                        import modules::CollectionUtils
                        output application/json
                        ---
                        CollectionUtils::chunk([1,2,3,4,5], 2)
                    ]]></ee:set-payload>
                </ee:message>
            </ee:transform>
        </munit:execution>
        <munit:validation>
            <munit-tools:assert-that
                expression="#[payload]"
                is="#[MunitTools::equalTo([[1,2],[3,4],[5]])]"/>
        </munit:validation>
    </munit:test>

    <munit:test name="test-chunk-size-larger-than-array"
                description="chunk returns single chunk when size exceeds array length">
        <munit:execution>
            <ee:transform>
                <ee:message>
                    <ee:set-payload><![CDATA[
                        %dw 2.0
                        import modules::CollectionUtils
                        output application/json
                        ---
                        CollectionUtils::chunk([1,2], 5)
                    ]]></ee:set-payload>
                </ee:message>
            </ee:transform>
        </munit:execution>
        <munit:validation>
            <munit-tools:assert-that
                expression="#[payload]"
                is="#[MunitTools::equalTo([[1,2]])]"/>
        </munit:validation>
    </munit:test>

    <!-- ==================== compact ==================== -->

    <munit:test name="test-compact-mixed"
                description="compact removes null and empty string values">
        <munit:execution>
            <ee:transform>
                <ee:message>
                    <ee:set-payload><![CDATA[
                        %dw 2.0
                        import modules::CollectionUtils
                        output application/json
                        ---
                        CollectionUtils::compact([1, null, 2, "", 3, null])
                    ]]></ee:set-payload>
                </ee:message>
            </ee:transform>
        </munit:execution>
        <munit:validation>
            <munit-tools:assert-that
                expression="#[payload]"
                is="#[MunitTools::equalTo([1, 2, 3])]"/>
        </munit:validation>
    </munit:test>

    <!-- ==================== intersection ==================== -->

    <munit:test name="test-intersection-basic"
                description="intersection returns common elements">
        <munit:execution>
            <ee:transform>
                <ee:message>
                    <ee:set-payload><![CDATA[
                        %dw 2.0
                        import modules::CollectionUtils
                        output application/json
                        ---
                        CollectionUtils::intersection([1,2,3], [2,3,4])
                    ]]></ee:set-payload>
                </ee:message>
            </ee:transform>
        </munit:execution>
        <munit:validation>
            <munit-tools:assert-that
                expression="#[payload]"
                is="#[MunitTools::equalTo([2,3])]"/>
        </munit:validation>
    </munit:test>

    <munit:test name="test-intersection-no-overlap"
                description="intersection returns empty array when no overlap">
        <munit:execution>
            <ee:transform>
                <ee:message>
                    <ee:set-payload><![CDATA[
                        %dw 2.0
                        import modules::CollectionUtils
                        output application/json
                        ---
                        CollectionUtils::intersection([1,2], [3,4])
                    ]]></ee:set-payload>
                </ee:message>
            </ee:transform>
        </munit:execution>
        <munit:validation>
            <munit-tools:assert-that
                expression="#[payload]"
                is="#[MunitTools::equalTo([])]"/>
        </munit:validation>
    </munit:test>

    <!-- ==================== difference ==================== -->

    <munit:test name="test-difference-basic"
                description="difference returns elements in a not in b">
        <munit:execution>
            <ee:transform>
                <ee:message>
                    <ee:set-payload><![CDATA[
                        %dw 2.0
                        import modules::CollectionUtils
                        output application/json
                        ---
                        CollectionUtils::difference([1,2,3,4], [2,4])
                    ]]></ee:set-payload>
                </ee:message>
            </ee:transform>
        </munit:execution>
        <munit:validation>
            <munit-tools:assert-that
                expression="#[payload]"
                is="#[MunitTools::equalTo([1,3])]"/>
        </munit:validation>
    </munit:test>

    <!-- ==================== union ==================== -->

    <munit:test name="test-union-basic"
                description="union combines arrays and removes duplicates">
        <munit:execution>
            <ee:transform>
                <ee:message>
                    <ee:set-payload><![CDATA[
                        %dw 2.0
                        import modules::CollectionUtils
                        output application/json
                        ---
                        CollectionUtils::union([1,2,3], [2,3,4,5])
                    ]]></ee:set-payload>
                </ee:message>
            </ee:transform>
        </munit:execution>
        <munit:validation>
            <munit-tools:assert-that
                expression="#[payload]"
                is="#[MunitTools::equalTo([1,2,3,4,5])]"/>
        </munit:validation>
    </munit:test>

    <!-- ==================== pick ==================== -->

    <munit:test name="test-pick-basic"
                description="pick selects specified keys from object">
        <munit:execution>
            <ee:transform>
                <ee:message>
                    <ee:set-payload><![CDATA[
                        %dw 2.0
                        import modules::CollectionUtils
                        output application/json
                        ---
                        CollectionUtils::pick({a:1, b:2, c:3}, ["a","c"])
                    ]]></ee:set-payload>
                </ee:message>
            </ee:transform>
        </munit:execution>
        <munit:validation>
            <munit-tools:assert-that
                expression="#[payload.a]"
                is="#[MunitTools::equalTo(1)]"/>
            <munit-tools:assert-that
                expression="#[payload.c]"
                is="#[MunitTools::equalTo(3)]"/>
            <munit-tools:assert-that
                expression="#[sizeOf(payload)]"
                is="#[MunitTools::equalTo(2)]"/>
        </munit:validation>
    </munit:test>

    <!-- ==================== omit ==================== -->

    <munit:test name="test-omit-basic"
                description="omit removes specified keys from object">
        <munit:execution>
            <ee:transform>
                <ee:message>
                    <ee:set-payload><![CDATA[
                        %dw 2.0
                        import modules::CollectionUtils
                        output application/json
                        ---
                        CollectionUtils::omit({a:1, b:2, c:3}, ["b"])
                    ]]></ee:set-payload>
                </ee:message>
            </ee:transform>
        </munit:execution>
        <munit:validation>
            <munit-tools:assert-that
                expression="#[payload.a]"
                is="#[MunitTools::equalTo(1)]"/>
            <munit-tools:assert-that
                expression="#[payload.c]"
                is="#[MunitTools::equalTo(3)]"/>
            <munit-tools:assert-that
                expression="#[sizeOf(payload)]"
                is="#[MunitTools::equalTo(2)]"/>
        </munit:validation>
    </munit:test>

    <!-- ==================== deepMerge ==================== -->

    <munit:test name="test-deepMerge-nested"
                description="deepMerge recursively merges nested objects">
        <munit:execution>
            <ee:transform>
                <ee:message>
                    <ee:set-payload><![CDATA[
                        %dw 2.0
                        import modules::CollectionUtils
                        output application/json
                        ---
                        CollectionUtils::deepMerge(
                            {a: 1, nested: {x: 1, y: 2}},
                            {a: 9, nested: {y: 99, z: 3}}
                        )
                    ]]></ee:set-payload>
                </ee:message>
            </ee:transform>
        </munit:execution>
        <munit:validation>
            <munit-tools:assert-that
                expression="#[payload.a]"
                is="#[MunitTools::equalTo(9)]"/>
            <munit-tools:assert-that
                expression="#[payload.nested.x]"
                is="#[MunitTools::equalTo(1)]"/>
            <munit-tools:assert-that
                expression="#[payload.nested.y]"
                is="#[MunitTools::equalTo(99)]"/>
            <munit-tools:assert-that
                expression="#[payload.nested.z]"
                is="#[MunitTools::equalTo(3)]"/>
        </munit:validation>
    </munit:test>

    <munit:test name="test-deepMerge-new-keys"
                description="deepMerge adds keys from b not in a">
        <munit:execution>
            <ee:transform>
                <ee:message>
                    <ee:set-payload><![CDATA[
                        %dw 2.0
                        import modules::CollectionUtils
                        output application/json
                        ---
                        CollectionUtils::deepMerge({a: 1}, {b: 2})
                    ]]></ee:set-payload>
                </ee:message>
            </ee:transform>
        </munit:execution>
        <munit:validation>
            <munit-tools:assert-that
                expression="#[payload.a]"
                is="#[MunitTools::equalTo(1)]"/>
            <munit-tools:assert-that
                expression="#[payload.b]"
                is="#[MunitTools::equalTo(2)]"/>
        </munit:validation>
    </munit:test>

    <!-- ==================== pivot ==================== -->

    <munit:test name="test-pivot-basic"
                description="pivot converts rows to columns">
        <munit:execution>
            <ee:transform>
                <ee:message>
                    <ee:set-payload><![CDATA[
                        %dw 2.0
                        import modules::CollectionUtils
                        output application/json
                        ---
                        CollectionUtils::pivot([
                            {name: "Alice", score: 90},
                            {name: "Bob", score: 80}
                        ])
                    ]]></ee:set-payload>
                </ee:message>
            </ee:transform>
        </munit:execution>
        <munit:validation>
            <munit-tools:assert-that
                expression="#[payload.name]"
                is="#[MunitTools::equalTo(['Alice','Bob'])]"/>
            <munit-tools:assert-that
                expression="#[payload.score]"
                is="#[MunitTools::equalTo([90,80])]"/>
        </munit:validation>
    </munit:test>

    <!-- ==================== unpivot ==================== -->

    <munit:test name="test-unpivot-basic"
                description="unpivot converts columns to rows">
        <munit:execution>
            <ee:transform>
                <ee:message>
                    <ee:set-payload><![CDATA[
                        %dw 2.0
                        import modules::CollectionUtils
                        output application/json
                        ---
                        CollectionUtils::unpivot({
                            name: ["Alice", "Bob"],
                            score: [90, 80]
                        })
                    ]]></ee:set-payload>
                </ee:message>
            </ee:transform>
        </munit:execution>
        <munit:validation>
            <munit-tools:assert-that
                expression="#[payload[0].name]"
                is="#[MunitTools::equalTo('Alice')]"/>
            <munit-tools:assert-that
                expression="#[payload[1].score]"
                is="#[MunitTools::equalTo(80)]"/>
            <munit-tools:assert-that
                expression="#[sizeOf(payload)]"
                is="#[MunitTools::equalTo(2)]"/>
        </munit:validation>
    </munit:test>

    <!-- ==================== flattenKeys ==================== -->

    <munit:test name="test-flattenKeys-nested"
                description="flattenKeys converts nested keys to dot-notation">
        <munit:execution>
            <ee:transform>
                <ee:message>
                    <ee:set-payload><![CDATA[
                        %dw 2.0
                        import modules::CollectionUtils
                        output application/json
                        ---
                        CollectionUtils::flattenKeys({a: {b: 1, c: {d: 2}}}, ".")
                    ]]></ee:set-payload>
                </ee:message>
            </ee:transform>
        </munit:execution>
        <munit:validation>
            <munit-tools:assert-that
                expression="#[payload.'a.b']"
                is="#[MunitTools::equalTo(1)]"/>
            <munit-tools:assert-that
                expression="#[payload.'a.c.d']"
                is="#[MunitTools::equalTo(2)]"/>
        </munit:validation>
    </munit:test>

    <munit:test name="test-flattenKeys-custom-separator"
                description="flattenKeys uses custom separator">
        <munit:execution>
            <ee:transform>
                <ee:message>
                    <ee:set-payload><![CDATA[
                        %dw 2.0
                        import modules::CollectionUtils
                        output application/json
                        ---
                        CollectionUtils::flattenKeys({user: {name: "Alice"}}, "_")
                    ]]></ee:set-payload>
                </ee:message>
            </ee:transform>
        </munit:execution>
        <munit:validation>
            <munit-tools:assert-that
                expression="#[payload.user_name]"
                is="#[MunitTools::equalTo('Alice')]"/>
        </munit:validation>
    </munit:test>

    <!-- ==================== unique ==================== -->

    <munit:test name="test-unique-basic"
                description="unique removes duplicate values">
        <munit:execution>
            <ee:transform>
                <ee:message>
                    <ee:set-payload><![CDATA[
                        %dw 2.0
                        import modules::CollectionUtils
                        output application/json
                        ---
                        CollectionUtils::unique([1,2,2,3,3,3])
                    ]]></ee:set-payload>
                </ee:message>
            </ee:transform>
        </munit:execution>
        <munit:validation>
            <munit-tools:assert-that
                expression="#[payload]"
                is="#[MunitTools::equalTo([1,2,3])]"/>
        </munit:validation>
    </munit:test>

    <munit:test name="test-unique-strings"
                description="unique works with string arrays">
        <munit:execution>
            <ee:transform>
                <ee:message>
                    <ee:set-payload><![CDATA[
                        %dw 2.0
                        import modules::CollectionUtils
                        output application/json
                        ---
                        CollectionUtils::unique(["a","b","a","c","b"])
                    ]]></ee:set-payload>
                </ee:message>
            </ee:transform>
        </munit:execution>
        <munit:validation>
            <munit-tools:assert-that
                expression="#[payload]"
                is="#[MunitTools::equalTo(['a','b','c'])]"/>
        </munit:validation>
    </munit:test>

    <!-- ==================== partition ==================== -->

    <munit:test name="test-partition-even-odd"
                description="partition splits array by predicate into pass/fail">
        <munit:execution>
            <ee:transform>
                <ee:message>
                    <ee:set-payload><![CDATA[
                        %dw 2.0
                        import modules::CollectionUtils
                        output application/json
                        ---
                        CollectionUtils::partition([1,2,3,4,5], (n) -> mod(n, 2) == 0)
                    ]]></ee:set-payload>
                </ee:message>
            </ee:transform>
        </munit:execution>
        <munit:validation>
            <munit-tools:assert-that
                expression="#[payload.pass]"
                is="#[MunitTools::equalTo([2,4])]"/>
            <munit-tools:assert-that
                expression="#[payload.fail]"
                is="#[MunitTools::equalTo([1,3,5])]"/>
        </munit:validation>
    </munit:test>

    <!-- ==================== indexBy ==================== -->

    <munit:test name="test-indexBy-basic"
                description="indexBy creates keyed lookup from array">
        <munit:execution>
            <ee:transform>
                <ee:message>
                    <ee:set-payload><![CDATA[
                        %dw 2.0
                        import modules::CollectionUtils
                        output application/json
                        ---
                        CollectionUtils::indexBy([
                            {id: "a", val: 1},
                            {id: "b", val: 2}
                        ], "id")
                    ]]></ee:set-payload>
                </ee:message>
            </ee:transform>
        </munit:execution>
        <munit:validation>
            <munit-tools:assert-that
                expression="#[payload.a.val]"
                is="#[MunitTools::equalTo(1)]"/>
            <munit-tools:assert-that
                expression="#[payload.b.val]"
                is="#[MunitTools::equalTo(2)]"/>
        </munit:validation>
    </munit:test>

    <!-- ==================== countBy ==================== -->

    <munit:test name="test-countBy-even-odd"
                description="countBy groups and counts by function result">
        <munit:execution>
            <ee:transform>
                <ee:message>
                    <ee:set-payload><![CDATA[
                        %dw 2.0
                        import modules::CollectionUtils
                        output application/json
                        ---
                        CollectionUtils::countBy([1,2,3,4,5], (n) -> if (mod(n,2)==0) "even" else "odd")
                    ]]></ee:set-payload>
                </ee:message>
            </ee:transform>
        </munit:execution>
        <munit:validation>
            <munit-tools:assert-that
                expression="#[payload.odd]"
                is="#[MunitTools::equalTo(3)]"/>
            <munit-tools:assert-that
                expression="#[payload.even]"
                is="#[MunitTools::equalTo(2)]"/>
        </munit:validation>
    </munit:test>

    <munit:test name="test-countBy-strings"
                description="countBy counts string categories">
        <munit:execution>
            <ee:transform>
                <ee:message>
                    <ee:set-payload><![CDATA[
                        %dw 2.0
                        import modules::CollectionUtils
                        output application/json
                        ---
                        CollectionUtils::countBy(["apple","banana","avocado","blueberry"], (s) -> s[0])
                    ]]></ee:set-payload>
                </ee:message>
            </ee:transform>
        </munit:execution>
        <munit:validation>
            <munit-tools:assert-that
                expression="#[payload.a]"
                is="#[MunitTools::equalTo(2)]"/>
            <munit-tools:assert-that
                expression="#[payload.b]"
                is="#[MunitTools::equalTo(2)]"/>
        </munit:validation>
    </munit:test>

</mule>
