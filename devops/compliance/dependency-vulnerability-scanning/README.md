## Dependency Vulnerability Scanning
> OWASP Dependency-Check and Snyk integration for Mule project CI pipelines

### When to Use
- Security policy requires scanning all dependencies for known CVEs
- You need automated vulnerability detection in CI before deployment
- You want to enforce severity thresholds that block deployments

### Configuration

**pom.xml — OWASP Dependency-Check Maven plugin**
```xml
<plugin>
    <groupId>org.owasp</groupId>
    <artifactId>dependency-check-maven</artifactId>
    <version>9.0.9</version>
    <configuration>
        <failBuildOnCVSS>7</failBuildOnCVSS>
        <suppressionFiles>
            <suppressionFile>owasp-suppressions.xml</suppressionFile>
        </suppressionFiles>
        <formats>
            <format>HTML</format>
            <format>JSON</format>
            <format>JUNIT</format>
        </formats>
        <outputDirectory>target/dependency-check</outputDirectory>
        <nvdApiKey>${NVD_API_KEY}</nvdApiKey>
        <assemblyAnalyzerEnabled>false</assemblyAnalyzerEnabled>
    </configuration>
</plugin>
```

**owasp-suppressions.xml — suppress false positives**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<suppressions xmlns="https://jeremylong.github.io/DependencyCheck/dependency-suppression.1.3.xsd">
    <!-- Suppress known false positive for Mule runtime internals -->
    <suppress>
        <notes>Mule runtime internal dependency, not directly exploitable</notes>
        <packageUrl regex="true">^pkg:maven/org\.mule\.runtime/.*$</packageUrl>
        <cve>CVE-2023-XXXXX</cve>
    </suppress>

    <!-- Suppress until patch is available (with expiry) -->
    <suppress until="2026-06-01Z">
        <notes>No patch available yet; mitigated by WAF rules</notes>
        <packageUrl regex="true">^pkg:maven/com\.example/vulnerable-lib@.*$</packageUrl>
        <cvssBelow>9</cvssBelow>
    </suppress>
</suppressions>
```

**Snyk CLI integration**
```bash
#!/usr/bin/env bash
set -euo pipefail

echo "=== Snyk Vulnerability Scan ==="

# Authenticate (API token from env)
export SNYK_TOKEN="$SNYK_API_TOKEN"

# Test for vulnerabilities
snyk test \
    --file=pom.xml \
    --severity-threshold=high \
    --json-file-output=target/snyk-results.json \
    --org="$SNYK_ORG_ID" || true

# Check results
CRITICAL=$(jq '[.vulnerabilities[] | select(.severity == "critical")] | length' target/snyk-results.json)
HIGH=$(jq '[.vulnerabilities[] | select(.severity == "high")] | length' target/snyk-results.json)

echo "Critical: $CRITICAL | High: $HIGH"

if [ "$CRITICAL" -gt 0 ]; then
    echo "BLOCKED: $CRITICAL critical vulnerabilities found."
    jq '.vulnerabilities[] | select(.severity == "critical") | {title, severity, packageName, version, fixedIn}' target/snyk-results.json
    exit 1
fi

if [ "$HIGH" -gt 5 ]; then
    echo "WARNING: $HIGH high-severity vulnerabilities found."
fi

# Monitor project (adds to Snyk dashboard)
snyk monitor --file=pom.xml --org="$SNYK_ORG_ID"

echo "Vulnerability scan complete."
```

**GitHub Actions integration**
```yaml
name: Security Scan

on:
  pull_request:
    branches: [main]
  schedule:
    - cron: "0 6 * * 1"  # Weekly Monday scan

jobs:
  owasp-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Cache NVD database
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository/org/owasp
          key: owasp-nvd-${{ hashFiles('pom.xml') }}

      - name: Run OWASP Dependency-Check
        run: mvn dependency-check:check -B -DNVD_API_KEY=${{ secrets.NVD_API_KEY }}

      - name: Upload OWASP report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: owasp-report
          path: target/dependency-check/

      - name: Publish test results
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: OWASP Results
          path: target/dependency-check/dependency-check-junit.xml
          reporter: java-junit

  snyk-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Snyk
        uses: snyk/actions/maven@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high
          command: test

      - name: Monitor with Snyk
        if: github.ref == 'refs/heads/main'
        uses: snyk/actions/maven@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: monitor
```

**GitLab CI integration**
```yaml
dependency-scan:
  stage: security
  image: maven:3.9-eclipse-temurin-17
  script:
    - mvn dependency-check:check -B -DNVD_API_KEY=$NVD_API_KEY
  artifacts:
    when: always
    paths:
      - target/dependency-check/
    reports:
      junit: target/dependency-check/dependency-check-junit.xml
  allow_failure: false
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_PIPELINE_SOURCE == "schedule"
```

**Vulnerability triage workflow**
```
1. CI scan detects vulnerability
2. Review severity and exploitability
3. Decision:
   a. Critical/High + exploitable → Fix immediately (upgrade dependency)
   b. Critical/High + not exploitable → Add suppression with expiry date + JIRA ticket
   c. Medium/Low → Track in backlog, review quarterly
   d. False positive → Add permanent suppression with explanation
4. Document all suppressions in owasp-suppressions.xml with notes
5. Re-scan to verify fix
```

### How It Works
1. **OWASP Dependency-Check** scans the Maven dependency tree against the NVD (National Vulnerability Database)
2. `failBuildOnCVSS=7` blocks deployments when any dependency has a CVSS score of 7 or higher
3. **Snyk** provides a second layer of scanning with its own vulnerability database and fix recommendations
4. Suppression files document accepted risks with expiration dates for periodic review
5. Weekly scheduled scans catch newly disclosed CVEs in existing dependencies
6. JUnit report format integrates with CI dashboards for visibility

### Gotchas
- OWASP Dependency-Check first run downloads the full NVD database (~2GB); cache it in CI
- NVD API key (free, rate-limited) significantly speeds up database updates; get one from nvd.nist.gov
- Mule runtime dependencies generate many false positives because Mule bundles older libraries internally
- Snyk and OWASP may report different CVEs; use both for comprehensive coverage
- Do not suppress vulnerabilities without documenting the reason and setting a review date
- Dependency-Check can take 5-15 minutes; run it as a parallel CI job, not blocking the main pipeline

### Related
- [docker-integration](../../testing/docker-integration/) — Scan Docker images too
- [jenkins](../../cicd-pipelines/jenkins/) — Jenkins pipeline integration
- [gitlab-ci](../../cicd-pipelines/gitlab-ci/) — GitLab CI integration
